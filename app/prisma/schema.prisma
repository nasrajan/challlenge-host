generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model User {
  id                  String          @id @default(cuid())
  name                String?
  email               String?         @unique
  emailVerified       DateTime?
  image               String?
  password            String?
  role                UserRole        @default(USER)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  accounts            Account[]
  activityLogs        ActivityLog[]
  organizedChallenges Challenge[]     @relation("OrganizedChallenges")
  participations      Participant[]
  scoreSnapshots      ScoreSnapshot[]
  sessions            Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  id         String   @id @default(cuid())

  @@unique([identifier, token])
}

model Challenge {
  id               String            @id @default(cuid())
  name             String
  description      String?
  startDate        DateTime
  endDate          DateTime
  status           ChallengeStatus   @default(UPCOMING)
  organizerId      String
  isPublic         Boolean           @default(true)
  timezone         String            @default("America/Los_Angeles")
  maxParticipants  Int?
  requiresApproval Boolean           @default(false)
  allowMultiParticipants Boolean     @default(false)
  showLeaderboard  Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  activityLogs     ActivityLog[]
  organizer        User              @relation("OrganizedChallenges", fields: [organizerId], references: [id], onDelete: Cascade)
  metrics          ChallengeMetric[]
  participants     Participant[]
}

model ChallengeMetric {
  id                 String            @id @default(cuid())
  challengeId        String
  name               String
  description        String?
  unit               String
  pointsPerUnit      Int?
  inputType          MetricInputType   @default(NUMBER)
  aggregationMethod  AggregationMethod @default(SUM)
  scoringFrequency   ScoringFrequency  @default(DAILY)
  maxPointsPerPeriod Float?
  maxPointsTotal     Float?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  activityLogs       ActivityLog[]
  challenge          Challenge         @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  qualifiers         MetricQualifier[]
  scoreSnapshots     ScoreSnapshot[]
  scoringRules       ScoringRule[]
}

model MetricQualifier {
  id           String          @id @default(cuid())
  metricId     String
  value        String
  activityLogs ActivityLog[]
  metric       ChallengeMetric @relation(fields: [metricId], references: [id], onDelete: Cascade)
  scoringRules ScoringRule[]

  @@unique([metricId, value])
}

model ScoringRule {
  id             String           @id @default(cuid())
  metricId       String
  qualifierId    String?
  comparisonType ComparisonType   @default(RANGE)
  minValue       Float?
  maxValue       Float?
  points         Float
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  metric         ChallengeMetric  @relation(fields: [metricId], references: [id], onDelete: Cascade)
  qualifier      MetricQualifier? @relation(fields: [qualifierId], references: [id])
}

model Participant {
  id          String            @id @default(cuid())
  userId      String
  challengeId String
  name        String            // Unique name for user within challenge
  displayName String?
  joinedAt    DateTime          @default(now())
  status      ParticipantStatus @default(PENDING)
  challenge   Challenge         @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  activityLogs ActivityLog[]
  scoreSnapshots ScoreSnapshot[]

  @@unique([userId, challengeId, name]) // Updated unique constraint
}

model ActivityLog {
  id            String           @id @default(cuid())
  userId        String
  participantId String?          // Optional for migration, will be required later
  challengeId   String
  date          DateTime
  value         Float
  evidenceUrl   String?
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  metricId      String
  qualifierId   String?
  challenge     Challenge        @relation(fields: [challengeId], references: [id])
  metric        ChallengeMetric  @relation(fields: [metricId], references: [id])
  qualifier     MetricQualifier? @relation(fields: [qualifierId], references: [id])
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  participant   Participant?     @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([userId, challengeId, metricId])
  @@index([participantId])
}

model ScoreSnapshot {
  id            String          @id @default(cuid())
  userId        String
  participantId String?         // Optional for migration
  challengeId   String
  metricId      String
  displayName   String?
  periodStart   DateTime
  periodEnd     DateTime
  rawPoints     Float
  cappedPoints  Float
  totalPoints   Float
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  metric        ChallengeMetric @relation(fields: [metricId], references: [id])
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  participant   Participant?    @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([userId, challengeId, metricId])
  @@index([participantId])
}

enum UserRole {
  USER
  ORGANIZER
  ADMIN
}

enum ChallengeStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum AggregationMethod {
  SUM
  AVERAGE
  MAX
  MIN
  COUNT
}

enum ScoringFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum ComparisonType {
  RANGE
  GREATER_THAN
  GREATER_THAN_EQUAL
}

enum MetricInputType {
  NUMBER
  CHECKBOX
  TEXT
}

enum ParticipantStatus {
  PENDING
  APPROVED
  REJECTED
  REVOKED
}
